<div class="flex flex-col gap-2 divide-y divide-gray-300 dark:divide-gray-700">
  @if (resourceRef().status() !== 'loading') {
    <div class="flex justify-between pb-2">
      <div class="flex">
        <button
          ngpButton
          uiButton
          [ngpTooltipTrigger]="RefreshTooltip"
          [ngpTooltipTriggerContainer]="tooltipContainer"
          (click)="resourceRef().reload()">
          <span class="sr-only">Reload data</span>
          <ng-icon name="heroArrowPath" />
        </button>
        <ng-template #RefreshTooltip>
          <div
            ngpTooltip
            uiTooltip>
            {{ 'misc.refresh' | translate }}
            <div
              ngpTooltipArrow
              uiTooltipArrow></div>
          </div>
        </ng-template>

        <div #tooltipContainer></div>
      </div>

      <button
        uiButton
        [ngpMenuTrigger]="pageSizeDropdown"
        class="data-open:*:[ng-icon]:rotate-180">
        {{ pageSize() }}
        <ng-icon
          name="heroChevronDown"
          class="ml-2 transition-transform duration-150 ease-in-out" />
      </button>
      <ng-template #pageSizeDropdown>
        <div
          ngpMenu
          uiMenu>
          @for (size of pageSizes; track $index) {
            <button
              ngpMenuItem
              uiMenuItem
              (click)="pageSize.set(size)">
              {{ size }}
            </button>
          }
        </div>
      </ng-template>
    </div>

    <div class="flex flex-col gap-2 pb-4">
      <ng-container
        [ngTemplateOutlet]="filtersDisplay"
        [ngTemplateOutletContext]="{ $implicit: _filters() }" />
      @if (_filters().length > 0) {
        <button
          ngpButton
          uiButton
          (click)="applyFilters()">
          Apply filters
        </button>
      } @else {
        <button
          ngpButton
          uiButton
          (click)="addFilter()"
          class="w-fit">
          +
        </button>
      }
    </div>
  }
  <div class="flex flex-col gap-2">
    @if (resourceRef().isLoading()) {
      <ui-loader />
    } @else if (resourceRef().error()) {
      <div class="flex flex-col gap-2">
        <div class="flex flex-col gap-2">
          <div>
            <span class="font-semibold">{{ 'misc.error.name' | translate }}</span>
          </div>
          <span>{{ resourceRef().error()?.name ?? '' }}</span>
        </div>
        <div class="flex flex-col gap-2">
          <div>
            <span class="font-semibold">{{ 'misc.error.message' | translate }}</span>
          </div>
          <span>{{ resourceRef().error()?.message ?? '' }}</span>
        </div>
      </div>
    } @else if (resourceRef().hasValue()) {
      @let value = resourceRef().value();

      @if (value !== undefined && value.data.length > 0) {
        <div class="overflow-scroll">
          <table
            uiTable
            [tableHeader]="header()"
            [tableBody]="body()"
            [tableFooter]="footer()"
            [data]="value.data"></table>
        </div>

        <ui-pagination
          class="self-end"
          [pageCount]="value.totalPages"
          [(page)]="pageNumber" />
      } @else {
        <div class="flex flex-col gap-2 place-self-center">
          <div class="flex flex-col gap-2">
            <div>
              <span class="font-semibold">{{ 'misc.no_data' | translate }}</span>
            </div>
          </div>
        </div>
      }
    }
  </div>
</div>

<ng-template
  #filtersDisplay
  let-filters>
  <div class="flex flex-col gap-3">
    @for (filter of filters; track $index) {
      <div class="ml-8 flex flex-col">
        <div class="flex gap-3">
          @if ($index > 0) {
            <div
              ngpCombobox
              uiCombobox
              [(ngpComboboxValue)]="filter.filterLogic">
              <button
                ngpComboboxButton
                uiButton>
                {{ filterRequestLogic[filter.filterLogic] }}
              </button>

              <div
                *ngpComboboxPortal
                ngpComboboxDropdown
                uiComboboxDropdown>
                @for (item of filterRequestLogic | enumKeyValuePair; track $index) {
                  <div
                    ngpComboboxOption
                    uiComboboxOption
                    [ngpComboboxOptionValue]="item.value">
                    {{ item.key }}
                  </div>
                }
              </div>
            </div>
          }

          <ng-container
            [ngTemplateOutlet]="filterDisplay"
            [ngTemplateOutletContext]="{ $implicit: filter }" />

          <button
            ngpButton
            uiButton
            (click)="addFilter(filter)"
            class="w-fit">
            +
          </button>
        </div>

        @if ($index === filters.length - 1) {
          <button
            ngpButton
            uiButton
            (click)="addFilter(filters)"
            class="w-fit">
            +
          </button>
        }
      </div>
    }
  </div>
</ng-template>

<ng-template
  #filterDisplay
  let-filter>
  <div class="flex flex-col gap-1.5">
    <div class="flex items-center gap-3">
      <div
        ngpCombobox
        uiCombobox
        [(ngpComboboxValue)]="filter.propertyName">
        <button
          ngpComboboxButton
          uiButton>
          {{ filter.propertyName }}
        </button>

        <div
          *ngpComboboxPortal
          ngpComboboxDropdown
          uiComboboxDropdown>
          @let properties = filterProperties();

          @if (properties !== undefined) {
            @for (property of properties; track $index) {
              <span
                ngpComboboxOption
                uiComboboxOption
                [ngpComboboxOptionValue]="property">
                {{ property }}
              </span>
            }
          }
        </div>
      </div>

      <div
        ngpCombobox
        uiCombobox
        [(ngpComboboxValue)]="filter.filterOperator">
        <button
          ngpComboboxButton
          uiButton>
          {{ `enum.filter_request_operator.${filter.filterOperator}` | translate }}
        </button>

        <div
          *ngpComboboxPortal
          ngpComboboxDropdown
          uiComboboxDropdown>
          @for (item of filterRequestOperator | enumKeyValuePair; track $index) {
            <div
              ngpComboboxOption
              uiComboboxOption
              [ngpComboboxOptionValue]="item.value">
              {{ `enum.filter_request_operator.${item.value}` | translate }}
            </div>
          }
        </div>
      </div>

      <input
        ngpInput
        uiInput
        [(ngModel)]="filter.value"
        [placeholder]="`misc.value` | translate" />
    </div>

    <ng-container
      [ngTemplateOutlet]="filtersDisplay"
      [ngTemplateOutletContext]="{ $implicit: filter.filters }" />
  </div>
</ng-template>
